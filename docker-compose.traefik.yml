# =============================================================================
# TinkerVoid Traefik Override
# =============================================================================
# This file adds Traefik reverse proxy support to the production deployment.
# Use with: docker compose -f docker-compose.prod.yml -f docker-compose.traefik.yml up -d
# =============================================================================

services:
  # Next.js Application - Traefik labels
  app:
    # Remove direct port exposure when using Traefik
    ports: !reset []
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.tinkervoid_app.rule=Host(`${TRAEFIK_HOST}`)
      - traefik.http.routers.tinkervoid_app.tls=true
      - traefik.http.routers.tinkervoid_app.tls.certresolver=${TRAEFIK_CERTRESOLVER:-le}
      - traefik.http.services.tinkervoid_app.loadbalancer.server.port=3000
    networks:
      - tinkervoid-internal
      - traefik

  # LiveKit Server - Traefik labels (WebSocket support)
  livekit:
    # Keep ports for UDP/TCP RTC and TURN traffic (cannot be proxied by Traefik)
    # Only HTTP/WebSocket (7880) can be proxied
    ports:
      - "${LIVEKIT_TCP_PORT:-7881}:7881"   # RTC over TCP (direct)
      - "${LIVEKIT_UDP_PORT:-7882}:7882/udp"  # RTC over UDP (direct)
      - "3478:3478/udp"   # TURN UDP (direct, required for NAT traversal)
      - "5349:5349"       # TURN TLS (direct, required for NAT traversal)
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik
      - traefik.http.routers.tinkervoid_livekit.rule=Host(`${TRAEFIK_LIVEKIT_HOST}`)
      - traefik.http.routers.tinkervoid_livekit.tls=true
      - traefik.http.routers.tinkervoid_livekit.tls.certresolver=${TRAEFIK_CERTRESOLVER:-le}
      - traefik.http.services.tinkervoid_livekit.loadbalancer.server.port=7880
    networks:
      - tinkervoid-internal
      - traefik

networks:
  traefik:
    external: true
